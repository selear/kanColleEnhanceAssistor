<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>装备改修助手</title>
    <link rel="stylesheet" href="lib/assistor.css">
</head>
<body>

<div id="app" class="container">
    <category-list :c-map="categoryMap"
                   :e-map="equipMap"></category-list>
    <enhance-today :e-map="equipMap"></enhance-today>
</div>

<template id="categoryList">
    <div :class="styleObj">
        <h2>这是categoryList</h2>
        <category v-for="(cEntity, idx) in cMap" :key="idx"
                  :c-entity="cEntity[1]"
                  :c-idx="idx"
                  :equip-map="equipFilterBy(cEntity[1].equipIds)">
        </category>
    </div>
</template>

<template id="enhanceToday">
    <div :class="styleObj">
        <div>Here comes CALC RESULTS</div>
        <pre v-for="(e, idx) in flat" :key="idx">{{ e.name }}</pre>
    </div>
</template>

<template id="category">
    <div>
        <h3 @click="display=!display">{{ cName }} -- {{ equipIds.length }}</h3>
        <transition-group tag="ul">
            <equip v-show="display"
                   v-for="(id, idx) in equipIds" :key="id"
                   :eid="id"
                   :idx="idx"
                   :e-entity="findEquipBy(id)"
                   @cb-changed="updateEquipIds">
            </equip>
        </transition-group>
    </div>
</template>

<template id="equip">
    <li>
        <label>
            <code>{{ eEntity.name }}</code>
            <input type="checkbox"
                   v-model="cbChecked"
                   :value="eid"
                   @change="cbChanged">
        </label>
    </li>
</template>

<script src="lib/vue.js"></script>
<script src="lib/equips.js"></script>
<script>

  // component equip
  let comEquip = {
    template: '#equip',
    data() {
      return {
        cbChecked: false
      }
    },
    props: ['eid', 'eEntity', 'idx'],
    methods: {
      cbChanged() {
        this.$emit('cb-changed', this.idx, this.eid, this.cbChecked);
      }
    }
  };

  // component category
  let comCategory = {
    template: '#category',
    data() {
      return {
        reduced: [],
        selectedEquipIdArr: [],
        display: false
      };
    },
    props: ['cEntity', 'equipMap', 'cIdx'],
    methods: {
      updateEquipIds: function (eIdx, eid, isChecked) {
        if (isChecked) {
          this.selectedEquipIdArr[eIdx] = eid;
        } else {
          this.selectedEquipIdArr[eIdx] = undefined;
        }
        this.reduced = this.selectedEquipIdArr.filter(elem => {
          return !!(elem);
        });
        this.$eventBus.$emit('update-today-enhance', this.cIdx, this.reduced);
      },
      findEquipBy(eid) {
        return this.equipMap.get(eid);
      }
    },
    computed: {
      cName: function () {
        return this.cEntity.name;
      },
      equipIds: function () {
        return this.cEntity.equipIds;
      }
    },
    components: {
      equip: comEquip
    }
  };

  // component category-list
  Vue.component('categoryList', {
    template: '#categoryList',
    data() {
      return {
        styleObj: {
          'list-panel': true
        }
      }
    },
    props: ['cMap', 'eMap'],
    methods: {
      equipFilterBy: function (eidArr) {
        let equipsInACategory = new Map();
        eidArr.forEach(eid => {
          equipsInACategory.set(eid, this.eMap.get(eid));
        });
        return equipsInACategory;
      }
    },
    components: {
      category: comCategory,
    }
  });

  // component enhance-today
  Vue.component('enhanceToday', {
    template: '#enhanceToday',
    data() {
      return {
        reducedList: [],
        categoryToList: [],
        styleObj: {
          'list-panel': true
        }
      }
    },
    props: ['eMap'],
    computed: {
      flat() {
        let flattedEquipArr = []
        this.reducedList.flat().forEach(eid => {
          flattedEquipArr.push(this.eMap.get(eid));
        });
        return flattedEquipArr;
      }
    },
    created() {
      this.$eventBus.$on('update-today-enhance', (cIdx, reduced) => {
        this.categoryToList[cIdx] = reduced;
        this.reducedList = this.categoryToList.filter((elem = []) => {
          return !!(elem.length);
        });
      });
    }
  });

  // 全局事件总线, 可以传递很多东西, 不仅仅是数据
  Vue.prototype.$eventBus = new Vue();

  const vm = new Vue({
    el: '#app',
    computed: {
      categoryMap() {
        return new Map(JSON.parse(META[0]));
      },
      equipMap() {
        return new Map(JSON.parse(META[1]))
      }
    }
  });

</script>
</body>
</html>